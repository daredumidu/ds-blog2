<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Policy Tool</title>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self';">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Ensure jsPDF is available globally
        window.PDFReady = false;
        window.addEventListener('load', function() {
            if (typeof window.jsPDF !== 'undefined') {
                window.PDFReady = true;
                console.log('PDF library loaded successfully');
            } else {
                console.error('PDF library failed to load');
            }
        });
    </script>
    <style>
        :root {
            /* Minimal gray color scheme */
            --color-infrastructure: #6b7280;
            --color-legislation: #9ca3af;
            --color-sustainability: #4b5563;
            --color-economy: #374151;
            --color-research: #6b7280;
            --color-gray-50: #f9fafb;
            --color-gray-100: #f3f4f6;
            --color-gray-200: #e5e7eb;
            --color-gray-300: #d1d5db;
            --color-gray-600: #4b5563;
            --color-gray-700: #374151;
            --color-gray-800: #1f2937;
            --color-blue-50: #eff6ff;
            --color-blue-600: #2563eb;
            --color-green-100: #dcfce7;
            --color-green-600: #16a34a;
            --color-green-700: #15803d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-white-50);
            padding: 0;
            min-height: 100vh;
            line-height: 1.5;
        }

        /* Header Banner Styles */
        .header-banner {
            width: 100vw;
            height: min(280px, 24vw);
            min-height: 200px;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #1e40af 100%);
            position: relative;
            margin-left: calc(-50vw + 50%);
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .header-banner::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255,255,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.08) 0%, transparent 50%),
                linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.03) 50%, transparent 60%);
        }

        .banner-content {
            position: relative;
            height: 100%;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }

        .g20-logo {
            position: absolute;
            top: 1.5rem;
            left: 2rem;
        }

        .logo-placeholder {
            background: rgba(255,255,255,0.9);
            color: #1e3a8a;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .banner-title {
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
            text-align: right;
        }

        .banner-title h1 {
            color: white;
            font-size: clamp(1.5rem, 4vw, 3rem);
            font-weight: 400;
            line-height: 1.2;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 0.5rem;
            padding: 0 0.5rem;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .section {
            background: white;
            padding: 0.4rem;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(255, 255, 255, 0.08);
        }

        .section h2 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-gray-800);
            margin-bottom: 0.1rem;
            letter-spacing: -0.025em;
        }

        /* Enhanced Dimension Buttons */
        .dimensions-container {
            display: flex;
            flex-wrap: nowrap; /* Keep horizontal on desktop */
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            overflow-x: auto; /* Allow horizontal scrolling if needed */
        }

        .dimension-btn {
            position: relative;
            padding: 0.375rem 1rem;
            border: 2px solid transparent;
            border-radius: 8px;
            min-height: 90px; 
            background: #f1f3f4;
            color: #5f6368;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            flex: 1; /* Equal width distribution */
            min-width: 120px; /* Smaller minimum width */
            max-width: 160px; /* Maximum width to control button size */
            text-align: center;
            letter-spacing: -0.01em;
            display: flex;
            flex-direction: column; /* Stack icon and text vertically */
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
            white-space: normal; /* Allow text wrapping */
            line-height: 1.2; /* Tighter line height for wrapped text */
        }

        .dimension-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .dimension-btn:active {
            transform: translateY(0);
            transition: transform 0.1s;
        }

        .dimension-btn.active {
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .dimension-icon {
            position: absolute;
            top: 20%;
            width: 30px;
            align-items: center;
            height: 30px;
            flex-shrink: 0;
            transition: opacity 0.2s ease;
        }

        .dimension-icon.colored {
            opacity: 1;
        }

        .dimension-icon.white {
            opacity: 0;
        }

        /* Show white icon when active */
        .dimension-btn.active .dimension-icon.colored {
            opacity: 0;
        }

        .dimension-btn.active .dimension-icon.white {
            opacity: 1;
        }
        
        /* Dimension-specific colors - updated to gray scheme */
        .dimension-btn[data-dimension="Enabling Infrastructure"] {
            background: #f3f4f6;
            color: #6b7280;
        }
        .dimension-btn[data-dimension="Enabling Infrastructure"]:hover {
            background: #e5e7eb;
        }
        .dimension-btn[data-dimension="Enabling Infrastructure"].active {
            background: #6b7280;
            color: white;
        }

        .dimension-btn[data-dimension="Legislation & Policy"] {
            background: #f9fafb;
            color: #9ca3af;
        }
        .dimension-btn[data-dimension="Legislation & Policy"]:hover {
            background: #f3f4f6;
        }
        .dimension-btn[data-dimension="Legislation & Policy"].active {
            background: #9ca3af;
            color: white;
        }

        .dimension-btn[data-dimension="Sustainability & Society"] {
            background: #f3f4f6;
            color: #4b5563;
        }
        .dimension-btn[data-dimension="Sustainability & Society"]:hover {
            background: #e5e7eb;
        }
        .dimension-btn[data-dimension="Sustainability & Society"].active {
            background: #4b5563;
            color: white;
        }

        .dimension-btn[data-dimension="Economy & Innovation"] {
            background: #f9fafb;
            color: #374151;
        }
        .dimension-btn[data-dimension="Economy & Innovation"]:hover {
            background: #f3f4f6;
        }
        .dimension-btn[data-dimension="Economy & Innovation"].active {
            background: #374151;
            color: white;
        }

        .dimension-btn[data-dimension="Research & Education"] {
            background: #f3f4f6;
            color: #6b7280;
        }
        .dimension-btn[data-dimension="Research & Education"]:hover {
            background: #e5e7eb;
        }
        .dimension-btn[data-dimension="Research & Education"].active {
            background: #6b7280;
            color: white;
        }

        /* Enhanced Phase Buttons */
        .phases-container {
            display: flex;
            gap: 0;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1px;
            transition: all 0.3s ease;
        }

        .phase-btn {
            flex: 1;
            padding: 0.575rem 1rem;
            border: none;
            background: transparent;
            color: #5f6368;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            position: relative;
            letter-spacing: -0.01em;
        }

        .phase-btn:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .phase-btn.active {
            background: white;
            color: #1a1a1a;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        /* Phase button colors based on selected dimension - updated to grays */
        .phases-container[data-dimension="Enabling Infrastructure"] .phase-btn:hover {
            background: rgba(107, 114, 128, 0.1);
        }
        .phases-container[data-dimension="Enabling Infrastructure"] .phase-btn.active {
            color: #6b7280;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }

        .phases-container[data-dimension="Legislation & Policy"] .phase-btn:hover {
            background: rgba(156, 163, 175, 0.1);
        }
        .phases-container[data-dimension="Legislation & Policy"] .phase-btn.active {
            color: #9ca3af;
            box-shadow: 0 2px 8px rgba(156, 163, 175, 0.2);
        }

        .phases-container[data-dimension="Sustainability & Society"] .phase-btn:hover {
            background: rgba(75, 85, 99, 0.1);
        }
        .phases-container[data-dimension="Sustainability & Society"] .phase-btn.active {
            color: #4b5563;
            box-shadow: 0 2px 8px rgba(75, 85, 99, 0.2);
        }

        .phases-container[data-dimension="Economy & Innovation"] .phase-btn:hover {
            background: rgba(55, 65, 81, 0.1);
        }
        .phases-container[data-dimension="Economy & Innovation"] .phase-btn.active {
            color: #374151;
            box-shadow: 0 2px 8px rgba(55, 65, 81, 0.2);
        }

        .phases-container[data-dimension="Research & Education"] .phase-btn:hover {
            background: rgba(107, 114, 128, 0.1);
        }
        .phases-container[data-dimension="Research & Education"] .phase-btn.active {
            color: #6b7280;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }

        /* Animation for phase container when dimension changes */
        .phases-container.updating {
            transform: scale(0.98);
            opacity: 0.7;
        }

        /* Focus states for accessibility */
        .dimension-btn:focus-visible,
        .phase-btn:focus-visible {
            outline: 2px solid #4285f4;
            outline-offset: 2px;
        }

        /* Two-column policy layout */
        .policy-container {
            display: grid;
            grid-template-columns: 0.8fr 1.2fr;
            gap: 0.5rem;
            min-height: 800px;
        }

        .policy-list-column {
            display: flex;
            flex-direction: column;
        }

        .policy-list-header {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-gray-800);
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: var(--color-gray-50);
            border-radius: 6px;
            text-align: center;
        }

        .policy-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            overflow-y: auto;
            max-height: 550px;
            padding-right: 0.25rem;
        }

        .policy-item {
            width: 100%;
            text-align: left;
            padding: 0.5rem;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .policy-item:hover {
            border-color: var(--color-gray-300);
            transform: translateY(-1px);
        }

        .policy-item:focus {
            outline: 2px solid var(--color-blue-600);
            outline-offset: 2px;
        }

        .policy-item.active {
            border-color: var(--color-blue-600);
            background: var(--color-blue-50);
        }

        .policy-item.selected {
            border-color: #0f7884;
            background: #cbe5ec;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Policy item colors based on selected dimension - updated to grays */
        .policy-list-column[data-dimension="Enabling Infrastructure"] .policy-item:hover {
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.05);
        }
        .policy-list-column[data-dimension="Enabling Infrastructure"] .policy-item.active {
            border-color: #6b7280;
            background: #f3f4f6;
            color: #374151;
        }
        .policy-list-column[data-dimension="Enabling Infrastructure"] .policy-item.selected {
            border-color: #4b5563;
            background: #e5e7eb;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }

        .policy-list-column[data-dimension="Legislation & Policy"] .policy-item:hover {
            border-color: #9ca3af;
            background: rgba(156, 163, 175, 0.05);
        }
        .policy-list-column[data-dimension="Legislation & Policy"] .policy-item.active {
            border-color: #9ca3af;
            background: #f9fafb;
            color: #4b5563;
        }
        .policy-list-column[data-dimension="Legislation & Policy"] .policy-item.selected {
            border-color: #6b7280;
            background: #f3f4f6;
            box-shadow: 0 2px 8px rgba(156, 163, 175, 0.2);
        }

        .policy-list-column[data-dimension="Sustainability & Society"] .policy-item:hover {
            border-color: #4b5563;
            background: rgba(75, 85, 99, 0.05);
        }
        .policy-list-column[data-dimension="Sustainability & Society"] .policy-item.active {
            border-color: #4b5563;
            background: #f3f4f6;
            color: #374151;
        }
        .policy-list-column[data-dimension="Sustainability & Society"] .policy-item.selected {
            border-color: #374151;
            background: #e5e7eb;
            box-shadow: 0 2px 8px rgba(75, 85, 99, 0.2);
        }

        .policy-list-column[data-dimension="Economy & Innovation"] .policy-item:hover {
            border-color: #374151;
            background: rgba(55, 65, 81, 0.05);
        }
        .policy-list-column[data-dimension="Economy & Innovation"] .policy-item.active {
            border-color: #374151;
            background: #f9fafb;
            color: #1f2937;
        }
        .policy-list-column[data-dimension="Economy & Innovation"] .policy-item.selected {
            border-color: #1f2937;
            background: #f3f4f6;
            box-shadow: 0 2px 8px rgba(55, 65, 81, 0.2);
        }

        .policy-list-column[data-dimension="Research & Education"] .policy-item:hover {
            border-color: #6b7280;
            background: rgba(107, 114, 128, 0.05);
        }
        .policy-list-column[data-dimension="Research & Education"] .policy-item.active {
            border-color: #6b7280;
            background: #f3f4f6;
            color: #374151;
        }
        .policy-list-column[data-dimension="Research & Education"] .policy-item.selected {
            border-color: #4b5563;
            background: #e5e7eb;
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.2);
        }

        .policy-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .policy-info {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .policy-id {
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-size: 0.7rem; 
            font-weight: 500;
            background: var(--color-gray-100);
            color: var(--color-gray-700);
            flex-shrink: 0;
        }

        .policy-id.selected {
            background: var(--color-green-100);
            color: var(--color-green-700);
        }

        .policy-title {
            font-weight: 500;
            line-height: 1.3;
            font-size: 0.8rem;
            color: var(--color-gray-800);
            word-wrap: break-word;
            white-space: normal;
        }

        .selected-icon {
            width: 1rem;
            height: 1rem;
            background: var(--color-blue-600);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        /* Policy details column */
        .policy-details-column {
            display: flex;
            flex-direction: column;
            background: white;
            font-size: 0.75rem;
            border: 1px solid var(--color-gray-200);
            border-radius: 8px;
            overflow-y: auto;
            max-height: 800px;
        }

        .details-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border-bottom: 1px solid var(--color-gray-200);
            background: var(--color-gray-50);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .details-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--color-gray-800);
        }

        .btn-select {
            padding: 0.4rem 0.8rem;
            border: none;
            border-radius: 6px;
            background: rgb(65, 22, 22);
            color: rgb(255, 255, 255);
            font-weight: 500;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-select:hover:not(:disabled) {
            background: #5c5d5f;
            transform: translateY(-1px);
        }

        .btn-select:focus {
            outline: 2px solid var(--color-blue-600);
            outline-offset: 2px;
        }

        .btn-select:disabled {
            background: var(--color-blue-100);
            color: var(--color-blue-700);
            cursor: not-allowed;
            transform: none;
        }

        .details-content {
            padding: 0.75rem;
            line-height: 1.6;
            color: var(--color-gray-600);
        }

        .detail-section {
            margin-bottom: 1rem;
        }

        .detail-section h3 {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-gray-800);
            margin-bottom: 0.5rem;
        }

        .examples-box {
            background: var(--color-gray-50);
            padding: 0.75rem;
            border-radius: 6px;
            border-left: 3px solid var(--color-gray-300);
            line-height: 1.5;
            font-size: 0.75rem;
        }

        .keywords-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
        }

        .keyword {
            padding: 0.2rem 0.5rem;
            background: var(--color-gray-100);
            color: var(--color-gray-700);
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .selection-matrix-container {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            overflow: auto;
            max-height: 400px;
            border: 1px solid #e5e7eb;
        }

        .matrix-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-gray-700);
            margin-bottom: 0.5rem;
        }

        .matrix-subtitle {
            font-size: 0.75rem;
            color: var(--color-gray-600);
            margin-bottom: 1rem;
        }

        /* New Architecture Styles */
        .architecture-forum {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 20px;
            height: 250px;
            background: #fafafa;
            border-radius: 8px;
            padding: 20px;
            position: relative;
            border: 1px solid #e5e7eb;
        }

        .minimal-pillar {
            width: 60px;
            display: flex;
            flex-direction: column-reverse;
            position: relative;
        }

        .pillar-section {
            height: 25px;
            margin-bottom: 2px;
            border-radius: 3px;
            position: relative;
            animation: buildSection 0.8s ease-out;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #d1d5db;
            background: #f9fafb;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .pillar-section:hover {
            transform: scale(1.02);
            border-color: #9ca3af;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* Policy-colored accent bar */
        .pillar-section::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 4px;
            right: 4px;
            height: 4px;
            border-radius: 2px;
            opacity: 0.8;
        }

        .pillar-section.infrastructure::before { background: #6b7280; }
        .pillar-section.legislation::before { background: #9ca3af; }
        .pillar-section.sustainability::before { background: #4b5563; }
        .pillar-section.economy::before { background: #374151; }
        .pillar-section.research::before { background: #6b7280; }

        .pillar-base {
            height: 12px;
            background: #e5e7eb;
            border-radius: 3px;
            margin-top: 4px;
            border: 1px solid #d1d5db;
        }

        .pillar-capital {
            position: absolute;
            top: -8px;
            left: -4px;
            right: -4px;
            height: 8px;
            background: #d1d5db;
            border-radius: 2px;
            border: 1px solid #9ca3af;
        }

        .pillar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: #6b7280;
            text-align: center;
            font-weight: 500;
        }

        @keyframes buildSection {
            from { 
                height: 0; 
                opacity: 0;
            }
            to { 
                height: 25px; 
                opacity: 1;
            }
        }

        .current-selection {
            background: linear-gradient(135deg, var(--color-blue-50), #e0e7ff);
            padding: 0.5rem;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
        }

        .selection-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 0.5rem;
        }

        .selection-info {
            font-size: 0.75rem;
            color: #1e40af;
            line-height: 1.4;
        }

        /* Expert profiles */
        .experts-section {
            background: white;
            padding: 0.75rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Export Buttons */
        .export-buttons {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .export-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border: 1px solid var(--color-gray-300);
            border-radius: 8px;
            background: white;
            color: var(--color-gray-700);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .export-btn:hover {
            background: var(--color-gray-50);
            border-color: var(--color-gray-400);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .export-btn:active {
            transform: translateY(0);
        }

        .export-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .export-pdf {
            border-color: #dc2626;
            color: #dc2626;
        }

        .export-pdf:hover:not(:disabled) {
            background: #fef2f2;
            border-color: #b91c1c;
        }

        .export-json {
            border-color: #2563eb;
            color: #2563eb;
        }

        .export-json:hover:not(:disabled) {
            background: #eff6ff;
            border-color: #1d4ed8;
        }

        .export-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .export-info {
            font-size: 0.7rem;
            color: var(--color-gray-500);
            text-align: center;
            font-style: italic;
        }

        .experts-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-gray-800);
            margin-bottom: 0.75rem;
        }

        .experts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
        }

        .expert-card {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--color-gray-200);
            border-radius: 6px;
            background: white;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .expert-card:hover {
            border-color: var(--color-blue-300);
            background: var(--color-blue-50);
        }

        .expert-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        .expert-info {
            flex: 1;
            min-width: 0;
        }

        .expert-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-gray-800);
            margin-bottom: 0.1rem;
        }

        .expert-role {
            font-size: 0.65rem;
            color: var(--color-gray-600);
            line-height: 1.2;
        }

        .hidden {
            display: none;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Loading state */
        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        /* Animation for policy selection */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.5s ease-in-out;
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 300px;
            color: var(--color-gray-500);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .header-banner {
                height: 200px;
                min-height: 180px;
            }

            .banner-content {
                padding: 0 1rem;
            }

            .g20-logo {
                top: 1rem;
                left: 1rem;
            }

            .logo-placeholder {
                padding: 0.4rem 0.8rem;
                font-size: 1rem;
            }

            .banner-title {
                right: 1rem;
                left: 1rem;
                text-align: center;
            }

            .banner-title h1 {
                font-size: 1.5rem;
            }

            .container {
                grid-template-columns: 1fr;
                padding: 0 1rem;
            }

            .dimensions-container {
                flex-direction: column;
                flex-wrap: wrap;
                overflow-x: visible;
            }
            
            .dimension-btn {
                min-width: auto;
                max-width: none;
                width: 100%;
                flex: none;
                flex-direction: row;
                gap: 0.5rem;
                justify-content: flex-start;
                text-align: left;
                white-space: nowrap;
                position: relative;
            }
            
            .phases-container {
                flex-direction: column;
                gap: 4px;
            }

            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Header Banner -->
    <div class="header-banner">
        <div class="banner-content">
            <!-- G20 Logo placeholder -->
            <div class="g20-logo">
                <div class="logo-placeholder">G20</div>
            </div>
            
            <!-- Title text -->
            <div class="banner-title">
                <h1>G20 Technology Policy<br />Assistance Facility</h1>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Left Panel -->
        <div class="left-panel">
            <!-- Enhanced Navigation -->
            <div class="section">
                <h2>Dimensions</h2>
                <div class="dimensions-container" id="dimensionGrid">
                    <!-- Dimensions will be populated by JavaScript -->
                </div>
                
                <h2>Implementation Phases</h2>
                <div class="phases-container" id="phaseGrid" data-dimension="">
                    <!-- Phases will be populated by JavaScript -->
                </div>
            </div>

            <!-- Two-Column Policy Layout -->
            <div class="section hidden" id="policySection">
                <div class="policy-container">
                    <!-- Left Column: Policy List -->
                    <div class="policy-list-column">
                        <div class="policy-list-header" id="policyListTitle">
                            Select a dimension and phase
                        </div>
                        <div class="policy-list" id="policyList">
                            <div class="empty-state">
                                <div class="empty-state-icon">📋</div>
                                <div class="empty-state-text">
                                    Choose a dimension and phase<br>to view available policies
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Policy Details -->
                    <div class="policy-details-column" id="policyDetailsColumn">
                        <div class="details-header">
                            <div class="details-title">Policy Details</div>
                            <button class="btn-select hidden" id="selectPolicyBtn" aria-describedby="select-help">
                                Select Policy
                            </button>
                        </div>
                        <div class="details-content" id="policyDetailsContent">
                            <div class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <div class="empty-state-text">
                                    Select a policy from the list<br>to view its details
                                </div>
                            </div>
                        </div>
                        <span id="select-help" class="sr-only">Select this policy to add it to your selection matrix</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <!-- Instructions -->
            <div class="section">
                <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">How to Use</h3>
                <div style="font-size: 0.75rem; color: var(--color-gray-600); line-height: 1.4;">
                    <div>1. Select a Dimension</div>
                    <div>2. Choose a Phase</div>
                    <div>3. Pick a Policy from the left list</div>
                    <div>4. Read details on the right and click "Select Policy"</div>
                    <div>5. Watch your governance architecture grow!</div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="section">
                <h3 style="font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem;">Export Report</h3>
                <div class="export-buttons">
                    <button class="export-btn export-pdf" onclick="exportToPDF()">
                        <span class="export-icon">📄</span>
                        Export PDF Report
                    </button>
                    <button class="export-btn export-json" onclick="exportToJSON()">
                        <span class="export-icon">💾</span>
                        Export Data (JSON)
                    </button>
                </div>
                <div class="export-info">
                    <span id="exportInfo">Select policies to generate your implementation report</span>
                </div>
            </div>
            
            <!-- Architecture Matrix -->
            <div class="selection-matrix-container">
                <div class="matrix-title">Governance Architecture</div>
                <div class="matrix-subtitle">Build institutional pillars with your selected policies</div>
                <div id="selectionGrid">
                    <!-- Architecture will be generated by JavaScript -->
                </div>
            </div>

            <!-- Current Selection -->
            <div class="current-selection" id="currentSelection">
                <div class="selection-title">Current Selection</div>
                <div class="selection-info" id="selectionInfo">
                    Select a dimension to begin
                </div>
            </div>

            <!-- Expert Profiles -->
            <div class="experts-section">
                <div class="experts-title">Policy Experts</div>
                <div class="experts-grid">
                    <div class="expert-card" title="Click to view Dr. X Y's profile">
                        <div class="expert-avatar" style="background-color: #6b7280;">SC</div>
                        <div class="expert-info">
                            <div class="expert-name">Dr.X Y</div>
                            <div class="expert-role">AI Infrastructure Specialist</div>
                        </div>
                    </div>
                    <div class="expert-card" title="Click to view Prof. Y Z's profile">
                        <div class="expert-avatar" style="background-color: #9ca3af;">MR</div>
                        <div class="expert-info">
                            <div class="expert-name">Prof. Y Z</div>
                            <div class="expert-role">Policy & Legislation Expert</div>
                        </div>
                    </div>
                    <div class="expert-card" title="Click to view Dr. A B's profile">
                        <div class="expert-avatar" style="background-color: #4b5563;">AO</div>
                        <div class="expert-info">
                            <div class="expert-name">Dr. A B</div>
                            <div class="expert-role">Sustainability & Ethics Lead</div>
                        </div>
                    </div>
                    <div class="expert-card" title="Click to view C D's profile">
                        <div class="expert-avatar" style="background-color: #374151;">JL</div>
                        <div class="expert-info">
                            <div class="expert-name">C D</div>
                            <div class="expert-role">Innovation Economist</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        'use strict';
        
        (function() {
            const CONFIG = {
                DIMENSIONS: [
                    { 
                        id: 'Enabling Infrastructure', 
                        color: '#6b7280', 
                        short: 'Enabling Infrastructure',
                        coloredIcon: 'assets/icons/blue-infrastructure.svg',
                        whiteIcon: 'assets/icons/white-infrastructure.svg'
                    },
                    { 
                        id: 'Legislation & Policy', 
                        color: '#9ca3af', 
                        short: 'Legislation & Policy',
                        coloredIcon: 'assets/icons/yellow-legislation.svg',
                        whiteIcon: 'assets/icons/white-legislation.svg'
                    },
                    { 
                        id: 'Sustainability & Society', 
                        color: '#4b5563', 
                        short: 'Sustainability & Society',
                        coloredIcon: 'assets/icons/purple-sustainability.svg',
                        whiteIcon: 'assets/icons/white-sustainability.svg'
                    },
                    { 
                        id: 'Economy & Innovation', 
                        color: '#374151', 
                        short: 'Economic Measures & Innovation',
                        coloredIcon: 'assets/icons/red-economy.svg',
                        whiteIcon: 'assets/icons/white-economy.svg'
                    },
                    { 
                        id: 'Research & Education', 
                        color: '#6b7280', 
                        short: 'Research, Education & Capacity Building',
                        coloredIcon: 'assets/icons/green-education.svg',
                        whiteIcon: 'assets/icons/white-education.svg'
                    }
                ],
                PHASES: [
                    { id: 'Analyse', short: 'Analyse' },
                    { id: 'Design', short: 'Design' },
                    { id: 'Implementation', short: 'Implementation' },
                    { id: 'Monitoring', short: 'Monitoring' }
                ]
            };

            // data structure
            const policyData = Object.freeze({
                'Enabling Infrastructure': Object.freeze({
                    'Analyse': Object.freeze({
                        'P1': Object.freeze({
                            policy: 'Identify infrastructure needs, gaps, and areas for improvement.',
                            details: 'Conduct comprehensive needs-based audits to systematically assess Infrastructure. For effective auditing, it is important to begin with an evidence-based assessment of current infrastructure needs, structured stakeholder consultations, and careful documentation of decisions, laying a solid foundation for transparent and measurable analysis.',
                            examples: 'Quantitative indicators and statistical sources such as the ITU\'s flagship Facts and Figures, tracks global connectivity through key indicators. Singapore\'s Smart Nation Initiative involves regular extensive needs assessments. UK\'s National Infrastructure Commission advises government on digital technologies rollout. South Korea\'s AI Framework Act Article 25 mandates comprehensive government support for AI data center development.',
                            keywords: Object.freeze(['needs assessment', 'audits', 'stakeholder consultation', 'evidence-based'])
                        }),
                        'P2': Object.freeze({
                            policy: 'Consult key stakeholders',
                            details: 'Consult key stakeholders to ensure audits reflect national and regional economic and social priorities, leveraging shared expertise.',
                            examples: '',
                            keywords: Object.freeze(['stakeholder engagement', 'consultation', 'priorities', 'shared expertise'])
                        })
                    }),
                    'Design': Object.freeze({
                        'P8': Object.freeze({
                            policy: 'Develop publicly owned infrastructure as a foundational layer',
                            details: 'By positioning the state as an active investor of AI infrastructure, governments can counteract current monopolistic tendencies in AI compute and create a more inclusive and responsible AI ecosystem.',
                            examples: 'Direct public investment in infrastructure, such as in national supercomputing centers or regional data hubs.',
                            keywords: Object.freeze(['public infrastructure', 'state investment', 'inclusive ecosystem', 'foundational layer'])
                        }),
                        'P9': Object.freeze({
                            policy: 'Encourage private-and not-for profit sector participation',
                            details: 'By combining direct public investments with financial incentives and policies that encourage private and non-profit sector participation and innovation.',
                            examples: 'Indonesia secured IDR120.2 trillion in AI investments in 2022-2023, including Microsoft\'s $1.7 billion investment in 2024.',
                            keywords: Object.freeze(['private sector', 'non-profit', 'participation', 'innovation'])
                        })
                    }),
                    'Implementation': Object.freeze({
                        'P17': Object.freeze({
                            policy: 'Cloud Procurement Policy and Governance',
                            details: 'Procurement Policies and Requirements for the use of Cloud in the Public Sector. Centralized online platforms can provide procuring agencies with a curated list of preapproved cloud service providers.',
                            examples: 'UK\'s "Government Cloud First" policy. Sovereign cloud initiatives like Gaia-X in Europe, India\'s MeghRaj, and Africa\'s AfriCloud. Australia\'s Hosting Certification Framework.',
                            keywords: Object.freeze(['cloud procurement', 'governance', 'public sector', 'security standards'])
                        }),
                        'P18': Object.freeze({
                            policy: 'Dedicated frameworks and guidelines on procuring AI technologies for the public sector',
                            details: 'Effective AI adoption in the public sector demands procurement policies capable of keeping pace with AI\'s fast-moving landscape.',
                            examples: 'UK\'s AI Dynamic Purchasing System. US Request for Information to align AI acquisitions. EU Commission\'s AI Public Procurement Community. Canada\'s list of qualified suppliers.',
                            keywords: Object.freeze(['AI procurement', 'public sector', 'frameworks', 'guidelines'])
                        })
                    }),
                    'Monitoring': Object.freeze({
                        'P22': Object.freeze({
                            policy: 'Develop a set of performance indicators to monitor and evaluate progress at each phase of the policy cycle',
                            details: 'Establishing performance indicators and feedback mechanisms helps assess progress, identify gaps, and refine strategies.',
                            examples: 'N/A',
                            keywords: Object.freeze(['performance indicators', 'monitoring', 'evaluation', 'feedback'])
                        })
                    })
                }),
                'Legislation & Policy': Object.freeze({
                    'Analyse': Object.freeze({
                        'P25': Object.freeze({
                            policy: 'Review and assess existing AI laws, definitions, and regulations.',
                            details: 'Conduct comprehensive reviews of current AI-related laws and definitions. Flexible definitions that focus on the risk profiles of AI systems, ensures the systems posing minimal risks are subject to lighter oversight.',
                            examples: 'The OECD definition articulates what an AI system is. The European Union\'s AI Act defines an AI system. UNESCO\'s approach has been to not provide a single definition.',
                            keywords: Object.freeze(['legal review', 'AI definitions', 'risk-based', 'regulations'])
                        })
                    }),
                    'Design': Object.freeze({
                        'P31': Object.freeze({
                            policy: 'Issue guidelines for ethical AI development and consult on hard vs soft legislative options.',
                            details: 'Develop ethical AI guidelines that promote responsible innovation and public trust.',
                            examples: 'UK promotes global AI standards through its AI Standards Hub. Germany champions AI standards via DIN. China uses a hybrid approach. Japan sets AI Governance Guidelines.',
                            keywords: Object.freeze(['ethical guidelines', 'hard law', 'soft law', 'public trust'])
                        })
                    }),
                    'Implementation': Object.freeze({
                        'P36': Object.freeze({
                            policy: 'Strengthen resources and training for regulatory bodies.',
                            details: 'Invest in regulator training on AI ethics, accountability, bias detection, and privacy.',
                            examples: 'Germany and South Korea have invested in AI-specific monitoring systems.',
                            keywords: Object.freeze(['regulator training', 'AI ethics', 'accountability', 'bias detection'])
                        })
                    }),
                    'Monitoring': Object.freeze({
                        'P41': Object.freeze({
                            policy: 'Establish key performance indicators to monitor regulatory impact and compliance.',
                            details: 'Use international benchmarking to compare and refine policies based on global best practices.',
                            examples: 'NA',
                            keywords: Object.freeze(['KPIs', 'monitoring', 'benchmarking', 'compliance'])
                        })
                    })
                }),
                'Sustainability & Society': Object.freeze({
                    'Analyse': Object.freeze({
                        'P45': Object.freeze({
                            policy: 'Assess the availability, accessibility, and gaps in digital literacy and AI skills',
                            details: '1. Skills gap analyses 2. Development of competency frameworks 3. Occupational standards 4. Certification programs 5. Labor market assessments 6. Training program benchmarks 7. National and regional AI skills indexes',
                            examples: 'Singapore\'s SkillsFuture initiative. Saudi Data and AI Authority National Occupational Standards Framework.',
                            keywords: Object.freeze(['skills assessment', 'digital literacy', 'competency frameworks', 'labor market'])
                        })
                    }),
                    'Design': Object.freeze({
                        'P54': Object.freeze({
                            policy: 'Provide guidance on sustainable and resource-efficient AI practices.',
                            details: '',
                            examples: 'UNESCO\'s Energy-Efficient AI Solutions & Policy Guidance initiative supports policymakers in addressing sustainability and equity challenges of generative AI.',
                            keywords: Object.freeze(['Sustainability & Society', 'resource efficiency', 'guidance', 'policy'])
                        })
                    }),
                    'Implementation': Object.freeze({
                        'P59': Object.freeze({
                            policy: 'Choose targeted measures such as scholarships, grants, and tax incentives',
                            details: 'Flexibility and inclusivity in program design play a crucial role in attracting diverse learners. Address unique challenges faced by underrepresented groups.',
                            examples: 'South Korea\'s Digital New Deal offers flexible online learning. Kenya\'s AkiraChix offers AI training for young women from underserved communities. Australia\'s Women in STEM Ambassador Program.',
                            keywords: Object.freeze(['targeted measures', 'scholarships', 'grants', 'inclusivity'])
                        })
                    }),
                    'Monitoring': Object.freeze({
                        'P65': Object.freeze({
                            policy: 'Establish systematic monitoring of AI environmental and social impacts',
                            details: 'Roll out public and private sector partnerships for AI apprenticeships, internships; and tailored skills-building programs',
                            examples: '',
                            keywords: Object.freeze(['monitoring', 'environmental impact', 'social impact', 'partnerships'])
                        })
                    })
                }),
                'Economy & Innovation': Object.freeze({
                    'Analyse': Object.freeze({
                        'P66': Object.freeze({
                            policy: 'Conduct scoping studies and foresight assessments',
                            details: '1) Conduct cross-sector assessments of AI R&D capacity and digital infrastructure 2) Map the evolving opportunity-risk landscape 3) Analyze public finance capacity for AI innovation and redistribution.',
                            examples: 'India\'s National Strategy for AI approaches sector prioritization with careful consideration. African Union High Level Panel on Emerging Technologies scoping study.',
                            keywords: Object.freeze(['scoping studies', 'foresight', 'R&D capacity', 'opportunity-risk'])
                        })
                    }),
                    'Design': Object.freeze({
                        'P69': Object.freeze({
                            policy: 'Embed public interest objectives into AI economic strategy',
                            details: '1) Translate sectoral priorities into funding strategies 2) Align public values with funding criteria 3) Establish intervention models for high-potential sectors.',
                            examples: 'Startup Chile Program and CORFO Innovation Grants. Rwanda Innovation Fund. South Korea\'s AI Framework Act Article 17. Japan\'s AI Act Articles 3-4.',
                            keywords: Object.freeze(['public interest', 'economic strategy', 'funding', 'intervention models'])
                        })
                    }),
                    'Implementation': Object.freeze({
                        'P73': Object.freeze({
                            policy: 'Establish governance mechanisms to support AI policy delivery',
                            details: 'Apply dynamic budgeting to realign spending based on performance and need',
                            examples: 'Singapore\'s Smart Nation & Digital Government Group',
                            keywords: Object.freeze(['governance', 'policy delivery', 'dynamic budgeting', 'performance'])
                        })
                    }),
                    'Monitoring': Object.freeze({
                        'P82': Object.freeze({
                            policy: 'Establish robust evaluation frameworks to track effectiveness',
                            details: '1) Develop multi-dimensional evaluation metrics 2) Build systems for real-time policy monitoring 3) Embed iterative policy reviews into national strategies.',
                            examples: '',
                            keywords: Object.freeze(['evaluation frameworks', 'metrics', 'monitoring', 'policy reviews'])
                        })
                    })
                }),
                'Research & Education': Object.freeze({
                    'Analyse': Object.freeze({
                        'P86': Object.freeze({
                            policy: 'Identify public interest research priorities',
                            details: 'Conduct collaborative needs assessments with stakeholders to design strategies for public interest-driven innovation.',
                            examples: 'Canada\'s Institute for Advanced Research AI & Society Program. UK Research and Innovation AI Review.',
                            keywords: Object.freeze(['research priorities', 'public interest', 'needs assessment', 'stakeholders'])
                        })
                    }),
                    'Design': Object.freeze({
                        'P89': Object.freeze({
                            policy: 'Encourage public-private partnerships and public AI research hubs',
                            details: 'Equitable funding models',
                            examples: 'EU\'s AI4EU Initiative. Japan\'s AI Act promotes shared use of large-scale information processing facilities.',
                            keywords: Object.freeze(['public-private partnerships', 'research hubs', 'funding models', 'equitable'])
                        })
                    }),
                    'Implementation': Object.freeze({
                        'P93': Object.freeze({
                            policy: 'Establish publicly funded AI research hubs, ethical prerequisites for funding access, and mechanisms to monitor research outputs',
                            details: 'Developing comprehensive guidelines to steer the ethical and responsible development and use of AI systems.',
                            examples: 'Argentina\'s Recommendations for Reliable AI. China\'s Global AI Governance Initiative. Australia\'s Centre of AI & Digital Ethics.',
                            keywords: Object.freeze(['research hubs', 'ethical prerequisites', 'monitoring', 'guidelines'])
                        })
                    }),
                    'Monitoring': Object.freeze({
                        'P96': Object.freeze({
                            policy: 'Develop performance indicators to measure the impact of AI policies on societal outcomes.',
                            details: 'Conduct impact assessments. Track equity metrics. Require post-grant transparency reports.',
                            examples: 'South Korea\'s AI Framework Act Article 38 establishes mandatory statistical compilation.',
                            keywords: Object.freeze(['performance indicators', 'impact assessment', 'equity metrics', 'transparency'])
                        })
                    })
                })
            });

            // Application state
            let state = {
                selectedDimension: null,
                selectedPhase: null,
                selectedPolicy: null,
                selectedPolicies: new Set(),
                isLoading: false
            };

            // Utility functions
            const utils = {
                escapeHtml: function(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },

                setText: function(element, text) {
                    if (element) {
                        element.textContent = text || '';
                    }
                },

                setLoading: function(isLoading) {
                    state.isLoading = isLoading;
                    document.body.classList.toggle('loading', isLoading);
                },

                isValidDimension: function(dimension) {
                    return CONFIG.DIMENSIONS.some(d => d.id === dimension);
                },

                isValidPhase: function(phase) {
                    return CONFIG.PHASES.some(p => p.id === phase);
                },

                isValidPolicy: function(dimension, phase, policy) {
                    return policyData[dimension] && 
                           policyData[dimension][phase] && 
                           policyData[dimension][phase][policy];
                },

                getPolicyKey: function(dimension, phase, policyId) {
                    return `${dimension}|${phase}|${policyId}`;
                },

                getDimensionShortName: function(dimension) {
                    const mapping = {
                        'Enabling Infrastructure': 'infrastructure',
                        'Legislation & Policy': 'legislation',
                        'Sustainability & Society': 'sustainability',
                        'Economy & Innovation': 'economy',
                        'Research & Education': 'research'
                    };
                    return mapping[dimension] || 'infrastructure';
                }
            };

            // Enhanced Button System Class
            class TPAFButtonSystem {
                constructor() {
                    this.dimensionNames = {
                        'Enabling Infrastructure': 'Enabling Infrastructure',
                        'Legislation & Policy': 'Legislation & Policy',
                        'Sustainability & Society': 'Sustainability & Society',
                        'Economy & Innovation': 'Economic Measures & Innovation',
                        'Research & Education': 'Research, Education & Capacity'
                    };
                    this.phaseNames = {
                        'Analyse': 'Analyse',
                        'Design': 'Design',
                        'Implementation': 'Implementation',
                        'Monitoring': 'Monitoring'
                    };
                }

                selectDimension(dimension) {
                    if (state.selectedDimension === dimension) return;

                    // Update active dimension button
                    document.querySelectorAll('.dimension-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector(`[data-dimension="${dimension}"]`).classList.add('active');

                    // Animate phase container transition and update dimension
                    const phasesContainer = document.querySelector('.phases-container');
                    phasesContainer.classList.add('updating');
                    
                    setTimeout(() => {
                        // Set the correct dimension attribute for phase color styling
                        phasesContainer.setAttribute('data-dimension', dimension);
                        phasesContainer.classList.remove('updating');
                    }, 150);

                    // Trigger dimension selection in main app
                    const dimConfig = CONFIG.DIMENSIONS.find(d => d.id === dimension);
                    if (dimConfig) {
                        app.selectDimension(dimension, dimConfig.color);
                    }
                    
                    this.dispatchSelectionEvent();
                }

                selectPhase(phase) {
                    if (state.selectedPhase === phase) return;

                    // Update active phase button
                    document.querySelectorAll('.phase-btn').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    document.querySelector(`[data-phase="${phase}"]`).classList.add('active');

                    // Trigger phase selection in main app
                    app.selectPhase(phase);
                    
                    this.dispatchSelectionEvent();
                }

                dispatchSelectionEvent() {
                    const event = new CustomEvent('tpafSelectionChange', {
                        detail: {
                            dimension: state.selectedDimension,
                            phase: state.selectedPhase,
                            dimensionName: this.dimensionNames[state.selectedDimension],
                            phaseName: this.phaseNames[state.selectedPhase]
                        }
                    });
                    document.dispatchEvent(event);
                }

                handleKeyboard(e) {
                    const activeElement = document.activeElement;
                    
                    if (activeElement.classList.contains('dimension-btn')) {
                        this.handleDimensionKeyboard(e, activeElement);
                    } else if (activeElement.classList.contains('phase-btn')) {
                        this.handlePhaseKeyboard(e, activeElement);
                    }
                }

                handleDimensionKeyboard(e, activeBtn) {
                    const dimensionBtns = Array.from(document.querySelectorAll('.dimension-btn'));
                    const currentIndex = dimensionBtns.indexOf(activeBtn);
                    let newIndex;

                    switch(e.key) {
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            e.preventDefault();
                            newIndex = currentIndex > 0 ? currentIndex - 1 : dimensionBtns.length - 1;
                            dimensionBtns[newIndex].focus();
                            break;
                        case 'ArrowRight':
                        case 'ArrowDown':
                            e.preventDefault();
                            newIndex = currentIndex < dimensionBtns.length - 1 ? currentIndex + 1 : 0;
                            dimensionBtns[newIndex].focus();
                            break;
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            this.selectDimension(activeBtn.dataset.dimension);
                            break;
                    }
                }

                handlePhaseKeyboard(e, activeBtn) {
                    const phaseBtns = Array.from(document.querySelectorAll('.phase-btn'));
                    const currentIndex = phaseBtns.indexOf(activeBtn);
                    let newIndex;

                    switch(e.key) {
                        case 'ArrowLeft':
                            e.preventDefault();
                            newIndex = currentIndex > 0 ? currentIndex - 1 : phaseBtns.length - 1;
                            phaseBtns[newIndex].focus();
                            break;
                        case 'ArrowRight':
                            e.preventDefault();
                            newIndex = currentIndex < phaseBtns.length - 1 ? currentIndex + 1 : 0;
                            phaseBtns[newIndex].focus();
                            break;
                        case 'Enter':
                        case ' ':
                            e.preventDefault();
                            this.selectPhase(activeBtn.dataset.phase);
                            break;
                    }
                }
            }

            // DOM manipulation functions
            const dom = {
                createDimensionButton: function(dimension, index) {
                    const button = document.createElement('button');
                    button.className = 'dimension-btn';
                    button.setAttribute('data-dimension', dimension.id);
                    button.setAttribute('aria-label', `Select ${dimension.id} dimension`);
                    
                    button.innerHTML = `
                        <img src="${dimension.coloredIcon}" alt="" class="dimension-icon colored" />
                        <img src="${dimension.whiteIcon}" alt="" class="dimension-icon white" />
                        ${utils.escapeHtml(dimension.short)}
                    `;
                    
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (!state.isLoading && utils.isValidDimension(dimension.id)) {
                            buttonSystem.selectDimension(dimension.id);
                        }
                    });
                    
                    return button;
                },

                createPhaseButton: function(phase, index) {
                    const button = document.createElement('button');
                    button.className = 'phase-btn';
                    button.setAttribute('data-phase', phase.id);
                    button.setAttribute('aria-label', `Select ${phase.id} phase`);
                    
                    button.innerHTML = `${utils.escapeHtml(phase.short)}`;
                    
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (!state.isLoading && utils.isValidPhase(phase.id)) {
                            buttonSystem.selectPhase(phase.id);
                        }
                    });
                    
                    return button;
                },

                createPolicyItem: function(policyId, policyInfo) {
                    const policyKey = utils.getPolicyKey(state.selectedDimension, state.selectedPhase, policyId);
                    const isSelected = state.selectedPolicies.has(policyKey);
                    
                    const button = document.createElement('button');
                    button.className = 'policy-item';
                    if (isSelected) {
                        button.classList.add('selected');
                    }
                    button.setAttribute('aria-label', `Select policy ${policyId}: ${policyInfo.policy}`);
                    button.setAttribute('data-policy-id', policyId);
                    
                    const selectedIcon = isSelected ? '<div class="selected-icon">✓</div>' : '';
                    
                    button.innerHTML = `
                        <div class="policy-header">
                            <div class="policy-info">
                                <span class="policy-title">${utils.escapeHtml(policyInfo.policy)}</span>
                            </div>
                            ${selectedIcon}
                        </div>
                    `;
                    
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (!state.isLoading && utils.isValidPolicy(state.selectedDimension, state.selectedPhase, policyId)) {
                            app.selectPolicy(policyId);
                        }
                    });
                    
                    return button;
                }
            };

            // Initialize button system
            const buttonSystem = new TPAFButtonSystem();

            // Main application logic
            const app = {
                init: function() {
                    this.renderDimensions();
                    this.renderPhases();
                    this.setupEventListeners();
                    this.generateSelectionGrid();
                },

                renderDimensions: function() {
                    const container = document.getElementById('dimensionGrid');
                    if (!container) return;
                    
                    container.innerHTML = '';
                    CONFIG.DIMENSIONS.forEach((dimension, index) => {
                        const button = dom.createDimensionButton(dimension, index);
                        container.appendChild(button);
                    });
                },

                renderPhases: function() {
                    const container = document.getElementById('phaseGrid');
                    if (!container) return;
                    
                    container.innerHTML = '';
                    CONFIG.PHASES.forEach((phase, index) => {
                        const button = dom.createPhaseButton(phase, index);
                        container.appendChild(button);
                    });
                },

                setupEventListeners: function() {
                    const selectPolicyBtn = document.getElementById('selectPolicyBtn');
                    if (selectPolicyBtn) {
                        selectPolicyBtn.addEventListener('click', (e) => {
                            e.preventDefault();
                            if (!state.isLoading) {
                                this.addPolicyToSelection();
                            }
                        });
                    }

                    // Keyboard navigation
                    document.addEventListener('keydown', (e) => {
                        buttonSystem.handleKeyboard(e);
                    });
                },

                selectDimension: function(dimension, color) {
                    if (!utils.isValidDimension(dimension)) return;
                    
                    utils.setLoading(true);
                    
                    state.selectedDimension = dimension;
                    state.selectedPhase = null;
                    state.selectedPolicy = null;

                    this.clearPolicyView();
                    this.updateCurrentSelection();
                    this.updateSelectionGrid();
                    utils.setLoading(false);
                },

                selectPhase: function(phase) {
                    if (!utils.isValidPhase(phase)) return;
                    
                    utils.setLoading(true);
                    
                    state.selectedPhase = phase;
                    state.selectedPolicy = null;

                    this.showPolicySection();
                    this.showPolicyList();
                    this.clearPolicyDetails();
                    this.updateCurrentSelection();
                    this.updateSelectionGrid();
                    
                    utils.setLoading(false);
                },

                showPolicySection: function() {
                    const section = document.getElementById('policySection');
                    if (section) {
                        section.classList.remove('hidden');
                    }
                },

                clearPolicyView: function() {
                    const section = document.getElementById('policySection');
                    if (section) {
                        section.classList.add('hidden');
                    }
                },

                showPolicyList: function() {
                    const title = document.getElementById('policyListTitle');
                    const list = document.getElementById('policyList');
                    const listColumn = document.querySelector('.policy-list-column');
                    
                    if (!title || !list) return;

                    // Set dimension attribute for styling
                    if (listColumn && state.selectedDimension) {
                        listColumn.setAttribute('data-dimension', state.selectedDimension);
                    }

                    utils.setText(title, `${state.selectedDimension} - ${state.selectedPhase}`);
                    
                    const policies = policyData[state.selectedDimension]?.[state.selectedPhase] || {};
                    
                    list.innerHTML = '';
                    const policyEntries = Object.entries(policies);
                    
                    if (policyEntries.length > 0) {
                        policyEntries.forEach(([policyId, policyInfo]) => {
                            const policyItem = dom.createPolicyItem(policyId, policyInfo);
                            list.appendChild(policyItem);
                        });
                    } else {
                        list.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">📋</div>
                                <div class="empty-state-text">
                                    No policies available<br>for this combination
                                </div>
                            </div>
                        `;
                    }
                },

                selectPolicy: function(policyId) {
                    if (!utils.isValidPolicy(state.selectedDimension, state.selectedPhase, policyId)) return;
                    
                    utils.setLoading(true);
                    
                    state.selectedPolicy = policyId;

                    document.querySelectorAll('.policy-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    const selectedItem = document.querySelector(`[data-policy-id="${policyId}"]`);
                    if (selectedItem) {
                        selectedItem.classList.add('active');
                    }

                    this.showPolicyDetails();
                    this.updateCurrentSelection();
                    this.updateSelectionGrid();
                    
                    utils.setLoading(false);
                },

                showPolicyDetails: function() {
                    const policyInfo = policyData[state.selectedDimension]?.[state.selectedPhase]?.[state.selectedPolicy];
                    if (!policyInfo) return;
                    
                    const detailsContent = document.getElementById('policyDetailsContent');
                    const selectPolicyBtn = document.getElementById('selectPolicyBtn');
                    
                    if (!detailsContent) return;
                    
                    const policyKey = utils.getPolicyKey(state.selectedDimension, state.selectedPhase, state.selectedPolicy);
                    const isSelected = state.selectedPolicies.has(policyKey);
                    
                    detailsContent.innerHTML = `
                        <div class="detail-section">
                            <h3>Policy</h3>
                            <p>${utils.escapeHtml(policyInfo.policy)}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h3>Details</h3>
                            <p>${utils.escapeHtml(policyInfo.details)}</p>
                        </div>
                        
                        ${policyInfo.examples ? `
                        <div class="detail-section">
                            <h3>Examples</h3>
                            <div class="examples-box">
                                ${utils.escapeHtml(policyInfo.examples)}
                            </div>
                        </div>
                        ` : ''}
                        
                        <div class="detail-section">
                            <h3>Keywords</h3>
                            <div class="keywords-container">
                                ${policyInfo.keywords.map(keyword => 
                                    `<span class="keyword">${utils.escapeHtml(keyword)}</span>`
                                ).join('')}
                            </div>
                        </div>
                    `;

                    if (selectPolicyBtn) {
                        utils.setText(selectPolicyBtn, isSelected ? 'Selected ✔' : 'Select Policy');
                        selectPolicyBtn.disabled = isSelected;
                        selectPolicyBtn.classList.remove('hidden');
                    }
                },

                clearPolicyDetails: function() {
                    const detailsContent = document.getElementById('policyDetailsContent');
                    const selectPolicyBtn = document.getElementById('selectPolicyBtn');
                    
                    if (detailsContent) {
                        detailsContent.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">📄</div>
                                <div class="empty-state-text">
                                    Select a policy from the list<br>to view its details
                                </div>
                            </div>
                        `;
                    }
                    
                    if (selectPolicyBtn) {
                        selectPolicyBtn.classList.add('hidden');
                    }
                },

                addPolicyToSelection: function() {
                    if (!state.selectedPolicy) return;
                    
                    const policyKey = utils.getPolicyKey(state.selectedDimension, state.selectedPhase, state.selectedPolicy);
                    state.selectedPolicies.add(policyKey);
                    
                    const selectedPolicy = document.querySelector('.policy-item.active');
                    if (selectedPolicy) {
                        selectedPolicy.classList.add('pulse');
                        setTimeout(() => selectedPolicy.classList.remove('pulse'), 500);
                    }
                    
                    this.showPolicyList();
                    this.showPolicyDetails();
                    this.updateSelectionGrid();
                },

                // NEW: Replace the old grid with architecture
                generateSelectionGrid: function() {
                    const container = document.getElementById('selectionGrid');
                    if (!container) return;
                    
                    container.innerHTML = '';
                    
                    const forum = document.createElement('div');
                    forum.className = 'architecture-forum';
                    
                    CONFIG.DIMENSIONS.forEach((dimension) => {
                        const pillar = document.createElement('div');
                        pillar.className = 'minimal-pillar';
                        pillar.setAttribute('data-dimension', dimension.id);
                        
                        const capital = document.createElement('div');
                        capital.className = 'pillar-capital';
                        
                        const base = document.createElement('div');
                        base.className = 'pillar-base';
                        
                        const label = document.createElement('div');
                        label.className = 'pillar-label';
                        label.textContent = utils.getDimensionShortName(dimension.id);
                        
                        pillar.appendChild(capital);
                        pillar.appendChild(base);
                        pillar.appendChild(label);
                        forum.appendChild(pillar);
                    });
                    
                    container.appendChild(forum);
                    this.addPolicyBarsToArchitecture();
                },

                // NEW: Add policy sections to architecture (incremental)
                addPolicyBarsToArchitecture: function() {
                    const pillars = document.querySelectorAll('.minimal-pillar');
                    
                    pillars.forEach(pillar => {
                        const dimensionId = pillar.getAttribute('data-dimension');
                        const dimensionShort = utils.getDimensionShortName(dimensionId);
                        
                        // Count existing sections
                        const existingSections = pillar.querySelectorAll('.pillar-section');
                        const currentSectionCount = existingSections.length;
                        
                        // Count how many policies should exist for this dimension
                        let targetPolicyCount = 0;
                        CONFIG.PHASES.forEach(phase => {
                            const selectedPoliciesInCell = Array.from(state.selectedPolicies).filter(policyKey => {
                                const [dim, ph, policyId] = policyKey.split('|');
                                return dim === dimensionId && ph === phase.id;
                            });
                            targetPolicyCount += selectedPoliciesInCell.length;
                        });
                        
                        // Only add new sections if we need more
                        const sectionsToAdd = targetPolicyCount - currentSectionCount;
                        
                        if (sectionsToAdd > 0) {
                            const base = pillar.querySelector('.pillar-base');
                            for (let i = 0; i < sectionsToAdd; i++) {
                                const section = document.createElement('div');
                                section.className = `pillar-section ${dimensionShort}`;
                                section.style.animationDelay = `${i * 0.1}s`;
                                pillar.insertBefore(section, base);
                            }
                        }
                        // Note: We're not handling removal of sections for now
                        // to maintain the building metaphor
                    });
                },

                getDimensionColor: function(dimension) {
                    const dimConfig = CONFIG.DIMENSIONS.find(d => d.id === dimension);
                    return dimConfig ? dimConfig.color : '#666';
                },

                // UPDATED: Use architecture instead of grid
                updateSelectionGrid: function() {
                    this.addPolicyBarsToArchitecture();
                },

                updateCurrentSelection: function() {
                    const infoElement = document.getElementById('selectionInfo');
                    const exportInfoElement = document.getElementById('exportInfo');
                    if (!infoElement) return;
                    
                    let content = '';
                    
                    if (state.selectedDimension) {
                        content += `<div><strong>Dimension:</strong> ${utils.escapeHtml(state.selectedDimension)}</div>`;
                    }
                    if (state.selectedPhase) {
                        content += `<div><strong>Phase:</strong> ${utils.escapeHtml(state.selectedPhase)}</div>`;
                    }
                    if (state.selectedPolicy) {
                        content += `<div><strong>Policy:</strong> ${utils.escapeHtml(state.selectedPolicy)}</div>`;
                        const policyKey = utils.getPolicyKey(state.selectedDimension, state.selectedPhase, state.selectedPolicy);
                        const isSelected = state.selectedPolicies.has(policyKey);
                        content += `<div class="status-badge ${isSelected ? 'status-selected' : 'status-viewing'}" style="background: ${isSelected ? 'var(--color-green-100)' : '#fef3c7'}; color: ${isSelected ? 'var(--color-green-700)' : '#92400e'}; display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-top: 0.5rem;">
                            ${isSelected ? 'Selected' : 'Viewing'}
                        </div>`;
                    }
                    
                    if (!content) {
                        content = 'Select a dimension to begin building';
                    }
                    
                    infoElement.innerHTML = content;

                    // Update export info
                    if (exportInfoElement) {
                        const selectedCount = state.selectedPolicies.size;
                        if (selectedCount === 0) {
                            exportInfoElement.textContent = 'Select policies to generate your implementation report';
                        } else {
                            exportInfoElement.textContent = `Ready to export report with ${selectedCount} selected policy${selectedCount === 1 ? '' : 'ies'}`;
                        }
                    }
                }
            };

            // Export Functions
            window.exportToPDF = function() {
                if (state.selectedPolicies.size === 0) {
                    alert('Please select at least one policy before exporting.');
                    return;
                }

                // Check if PDF library is ready
                if (!window.PDFReady || typeof window.jsPDF === 'undefined') {
                    alert('PDF library is still loading. Please wait a moment and try again, or use the JSON export.');
                    return;
                }

                try {
                    // Create new PDF document
                    const pdf = new window.jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });

                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const pageHeight = pdf.internal.pageSize.getHeight();
                    const margin = 20;
                    const contentWidth = pageWidth - (margin * 2);
                    let currentY = margin;

                    // Helper function to check page overflow and add new page
                    const checkPageOverflow = (requiredSpace = 40) => {
                        if (currentY > pageHeight - requiredSpace) {
                            pdf.addPage();
                            currentY = margin;
                            return true;
                        }
                        return false;
                    };

                    // Helper function to wrap text
                    const wrapText = (text, maxWidth) => {
                        try {
                            return pdf.splitTextToSize(text, maxWidth);
                        } catch (e) {
                            // Fallback if splitTextToSize fails
                            const words = text.split(' ');
                            const lines = [];
                            let currentLine = '';
                            
                            words.forEach(word => {
                                const testLine = currentLine ? currentLine + ' ' + word : word;
                                if (testLine.length * 2 < maxWidth) { // Rough character width estimation
                                    currentLine = testLine;
                                } else {
                                    if (currentLine) lines.push(currentLine);
                                    currentLine = word;
                                }
                            });
                            if (currentLine) lines.push(currentLine);
                            return lines;
                        }
                    };

                    // Helper function to render text safely
                    const renderText = (text, x, y, maxWidth, fontSize = 9) => {
                        if (!text) return 0;
                        
                        pdf.setFontSize(fontSize);
                        const lines = wrapText(text.toString(), maxWidth);
                        const lineHeight = fontSize * 0.5;
                        
                        lines.forEach((line, index) => {
                            const lineY = y + (index * lineHeight);
                            if (lineY > pageHeight - margin) {
                                pdf.addPage();
                                currentY = margin;
                                pdf.text(line, x, currentY);
                                currentY += lineHeight;
                            } else {
                                pdf.text(line, x, lineY);
                            }
                        });
                        
                        return lines.length * lineHeight;
                    };

                    // Cover Page
                    pdf.setFillColor(30, 58, 138);
                    pdf.rect(0, 0, pageWidth, pageHeight, 'F');
                    
                    // G20 TPAF Logo area
                    pdf.setFillColor(255, 255, 255);
                    pdf.rect(margin, margin, 60, 15, 'F');
                    pdf.setTextColor(30, 58, 138);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(12);
                    pdf.text('G20 TPAF', margin + 5, margin + 10);
                    
                    // Title
                    pdf.setTextColor(255, 255, 255);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(28);
                    pdf.text('AI Governance', pageWidth / 2, 80, { align: 'center' });
                    pdf.text('Implementation Plan', pageWidth / 2, 105, { align: 'center' });
                    
                    pdf.setFontSize(16);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text('G20 Technology Policy Assistance Facility', pageWidth / 2, 125, { align: 'center' });
                    
                    // Summary information
                    pdf.setFillColor(255, 255, 255, 0.15);
                    pdf.rect(margin + 20, 150, contentWidth - 40, 60, 'F');
                    
                    pdf.setFontSize(14);
                    pdf.setFont('helvetica', 'normal');
                    const today = new Date().toLocaleDateString('en-US', { 
                        year: 'numeric', month: 'long', day: 'numeric' 
                    });
                    pdf.text('Generated: ' + today, pageWidth / 2, 170, { align: 'center' });
                    pdf.text('Selected Policies: ' + state.selectedPolicies.size, pageWidth / 2, 185, { align: 'center' });
                    
                    const dimensionCount = new Set(Array.from(state.selectedPolicies).map(key => key.split('|')[0])).size;
                    pdf.text('Covering ' + dimensionCount + ' policy dimensions', pageWidth / 2, 200, { align: 'center' });

                    // Executive Summary Page
                    pdf.addPage();
                    currentY = margin;

                    pdf.setTextColor(0, 0, 0);
                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(20);
                    pdf.text('Executive Summary', margin, currentY);
                    currentY += 15;

                    pdf.setFont('helvetica', 'normal');
                    pdf.setFontSize(11);
                    
                    const summaryText = 'This implementation plan outlines ' + state.selectedPolicies.size + ' carefully selected AI governance policy options across ' + dimensionCount + ' key dimensions of the G20 Technology Policy Assistance Facility (TPAF) framework. These policies represent a comprehensive approach to establishing robust AI governance infrastructure, regulatory frameworks, and implementation strategies aligned with international best practices.';
                    
                    const summaryHeight = renderText(summaryText, margin, currentY, contentWidth, 11);
                    currentY += summaryHeight + 15;

                    // Detailed Content Page
                    pdf.addPage();
                    currentY = margin;

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(18);
                    pdf.text('Selected Policy Options', margin, currentY);
                    currentY += 15;

                    // Group policies by dimension
                    const policiesByDimension = {};
                    
                    Array.from(state.selectedPolicies).forEach(policyKey => {
                        const parts = policyKey.split('|');
                        const dimension = parts[0];
                        const phase = parts[1];
                        const policyId = parts[2];
                        
                        if (!policiesByDimension[dimension]) {
                            policiesByDimension[dimension] = [];
                        }
                        
                        const policyInfo = policyData[dimension] && policyData[dimension][phase] && policyData[dimension][phase][policyId];
                        if (policyInfo) {
                            policiesByDimension[dimension].push({
                                id: policyId,
                                phase: phase,
                                policy: policyInfo.policy,
                                details: policyInfo.details,
                                examples: policyInfo.examples,
                                keywords: policyInfo.keywords
                            });
                        }
                    });

                    // Render each dimension
                    Object.entries(policiesByDimension).forEach(([dimension, policies]) => {
                        checkPageOverflow(30);
                        
                        // Dimension header
                        const dimColors = {
                            'Enabling Infrastructure': [107, 114, 128],
                            'Legislation & Policy': [156, 163, 175],
                            'Sustainability & Society': [75, 85, 99],
                            'Economy & Innovation': [55, 65, 81],
                            'Research & Education': [107, 114, 128]
                        };
                        
                        const color = dimColors[dimension] || [107, 114, 128];
                        pdf.setFillColor(color[0], color[1], color[2]);
                        pdf.rect(margin, currentY, contentWidth, 12, 'F');
                        
                        pdf.setTextColor(255, 255, 255);
                        pdf.setFont('helvetica', 'bold');
                        pdf.setFontSize(14);
                        pdf.text(dimension, margin + 5, currentY + 8);
                        
                        pdf.setFontSize(10);
                        pdf.text(policies.length + ' policies selected', pageWidth - margin - 5, currentY + 8, { align: 'right' });
                        
                        currentY += 18;

                        // Render policies
                        policies.forEach((policy) => {
                            checkPageOverflow(50);
                            
                            // Policy background
                            pdf.setFillColor(248, 250, 252);
                            pdf.rect(margin, currentY, contentWidth, 8, 'F');
                            
                            // Color stripe
                            pdf.setFillColor(color[0], color[1], color[2]);
                            pdf.rect(margin, currentY, 3, 8, 'F');
                            
                            pdf.setTextColor(0, 0, 0);
                            pdf.setFont('helvetica', 'bold');
                            pdf.setFontSize(11);
                            
                            // Policy title
                            const titleText = policy.id + ': ' + policy.policy;
                            const titleHeight = renderText(titleText, margin + 6, currentY + 6, contentWidth - 12, 11);
                            currentY += Math.max(8, titleHeight + 2) + 5;

                            // Phase
                            pdf.setFont('helvetica', 'normal');
                            pdf.setFontSize(9);
                            pdf.setTextColor(75, 85, 99);
                            pdf.text('Implementation Phase: ' + policy.phase, margin, currentY);
                            currentY += 10;

                            // Details
                            if (policy.details) {
                                pdf.setTextColor(0, 0, 0);
                                pdf.setFont('helvetica', 'normal');
                                pdf.setFontSize(9);
                                const detailHeight = renderText(policy.details, margin, currentY, contentWidth, 9);
                                currentY += detailHeight + 5;
                            }

                            // Examples (abbreviated)
                            if (policy.examples) {
                                checkPageOverflow(15);
                                pdf.setFont('helvetica', 'bold');
                                pdf.setFontSize(9);
                                pdf.text('Examples:', margin, currentY);
                                currentY += 5;

                                pdf.setFont('helvetica', 'normal');
                                pdf.setFontSize(8);
                                const exampleText = policy.examples.length > 150 ? 
                                    policy.examples.substring(0, 150) + '...' : 
                                    policy.examples;
                                const exampleHeight = renderText(exampleText, margin, currentY, contentWidth, 8);
                                currentY += exampleHeight + 5;
                            }

                            // Keywords
                            if (policy.keywords && policy.keywords.length > 0) {
                                checkPageOverflow(8);
                                pdf.setFont('helvetica', 'bold');
                                pdf.setFontSize(8);
                                pdf.setTextColor(75, 85, 99);
                                pdf.text('Keywords: ', margin, currentY);
                                
                                pdf.setFont('helvetica', 'normal');
                                const keywordText = Array.isArray(policy.keywords) ? policy.keywords.join(', ') : policy.keywords;
                                renderText(keywordText, margin + 20, currentY, contentWidth - 20, 8);
                                currentY += 10;
                            }

                            currentY += 8; // Space between policies
                        });

                        currentY += 10; // Space between dimensions
                    });

                    // Add page numbers
                    const totalPages = pdf.internal.pages.length - 1;
                    for (let i = 1; i <= totalPages; i++) {
                        pdf.setPage(i);
                        if (i > 1) { // Skip cover page
                            pdf.setTextColor(128, 128, 128);
                            pdf.setFontSize(8);
                            pdf.text('Page ' + i + ' of ' + totalPages, pageWidth - margin, pageHeight - 10, { align: 'right' });
                            pdf.text('AI Governance Implementation Plan', margin, pageHeight - 10);
                        }
                    }

                    // Save the PDF
                    const timestamp = new Date().toISOString().split('T')[0];
                    pdf.save('AI_Governance_Implementation_Plan_' + timestamp + '.pdf');

                    console.log('PDF exported successfully');

                } catch (error) {
                    console.error('PDF export error:', error);
                    alert('PDF export failed: ' + error.message + '. Please try the JSON export or refresh the page.');
                }
            };

            window.exportToJSON = function() {
                if (state.selectedPolicies.size === 0) {
                    alert('Please select at least one policy before exporting.');
                    return;
                }

                // Prepare export data
                const exportData = {
                    metadata: {
                        generatedAt: new Date().toISOString(),
                        version: '1.0',
                        source: 'G20 TPAF AI Policy Tool',
                        title: 'AI Governance Implementation Plan'
                    },
                    summary: {
                        totalSelectedPolicies: state.selectedPolicies.size,
                        dimensionsCovered: new Set(Array.from(state.selectedPolicies).map(key => key.split('|')[0])).size,
                        phasesCovered: new Set(Array.from(state.selectedPolicies).map(key => key.split('|')[1])).size
                    },
                    selectedPolicies: []
                };

                // Process selected policies
                Array.from(state.selectedPolicies).forEach(policyKey => {
                    const [dimension, phase, policyId] = policyKey.split('|');
                    const policyInfo = policyData[dimension]?.[phase]?.[policyId];
                    
                    if (policyInfo) {
                        exportData.selectedPolicies.push({
                            id: policyId,
                            dimension: dimension,
                            phase: phase,
                            policy: policyInfo.policy,
                            details: policyInfo.details,
                            examples: policyInfo.examples,
                            keywords: policyInfo.keywords
                        });
                    }
                });

                // Download JSON file
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                const timestamp = new Date().toISOString().split('T')[0];
                link.download = `AI_Governance_Implementation_Plan_${timestamp}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            // Initialize the application
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    app.init();
                    
                    // Event listener for button system integration
                    document.addEventListener('tpafSelectionChange', (e) => {
                        console.log('Selection changed:', e.detail);
                    });
                });
            } else {
                app.init();
                
                // Event listener for button system integration
                document.addEventListener('tpafSelectionChange', (e) => {
                    console.log('Selection changed:', e.detail);
                });
            }

            // Development debugging (only in localhost)
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                window.AIPolicy = {
                    getState: () => ({ ...state }),
                    getSelectedPolicies: () => Array.from(state.selectedPolicies),
                    buttonSystem: buttonSystem
                };
            }

        })();
    </script>
</body>
</html>